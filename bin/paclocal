#!/bin/sh

function build_repo {
    NAME=$1
    paccache -rvc . -k1
    ls *.pkg.tar.xz > current.txt
    if [ -f last.txt ]; then
        files=$(comm -23 current.txt last.txt)
    else
        files=$(cat current.txt)
    fi
    repo-add "local-$NAME.db.tar.gz" $files
    mv -f current.txt last.txt
}

function main {
    DIR=/arch/pacman
    pkglist -n > $DIR/main.txt
    pkglist -m > $DIR/aur.txt
    pacman -Q > $DIR/all.txt

    # Update cached repositories
    cd $DIR/aur
    build_repo aur

    cd $DIR/main
    rsync -av /var/cache/pacman/pkg/ ./
    build_repo main

    # Sync pacman local db
    sudo pacman --config=$DIR/pacman.conf -Sy
}
main
