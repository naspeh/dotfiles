#!/bin/bash
PACDIR=/home/pacman

function usage {
    echo "Usage: pkglist [OPTIONS]"
    echo "  -L[nmtv] list packages (n: native; m: foreign; v: verbose; t: install time;)"
    echo "  -C      clean global pacman;"
    echo "  -P      save local packages;"
    echo "  -U      update local pacman;"
    exit 2
}

function clean {
    if [[ ! -n $(pacman -Qdt) ]]; then
        echo "No orphans to remove."
    else
        sudo pacman -Rs $(pacman -Qdtq)
    fi
}

function update_repo {
    clean_repo main 1
    clean_repo abs 1

    # Sync pacman local db
    sudo pacman --config=$PACDIR/pacman.conf -Sy
}

function clean_repo {
    cd $PACDIR/$1
    dbfile="local-$1.db"
    sudo rm -f $dbfile*
    sudo paccache -rvc . -k1
    if [ $2 ]; then
        sudo repo-add "local-$1.db.tar.gz" *.pkg.tar.xz
    fi
}

function save_packages {
    pkglist -ln > $PACDIR/main.txt
    pkglist -lm > $PACDIR/abs.txt
    pacman -Q > $PACDIR/all.txt

    clean_repo abs

    sudo rsync -av /var/cache/pacman/pkg/ $PACDIR/main/
    clean_repo main
}
function list_packages {
    list=$(comm -23 <(pacman -Qeq$filter) <(pacman -Qgq base base-devel | sort))
    expac -Q -t '%Y-%m-%d %H:%M' "$format_time$format" $(echo $list)
}

creset="\e[0m"
cpurple="\e[1;35m"
cgray="\e[0;37m"
cbold="\e[1m"
format="$cpurple%n$creset"
format_time=""

while getopts "hCPULmntv" opt; do
    case $opt in
        h) operation=usage;;
        C) operation=clean;;
        P) operation=save_packages;;
        U) operation=update_repo;;
        L) operation=list_packages;;
        v) format="$format: $cgray$cbold%d$creset $cgray(%u)$creset";;
        t) format_time="%l ";;
        n) filter="n";;
        m) filter="m";;
    esac
done

if [ $operation ]; then
    $operation
else
    usage
fi
