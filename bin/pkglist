#!/bin/bash
PACDIR=/home/pacman

function usage {
    echo "Usage: pkglist [OPTIONS]"
    echo "  -l[vnmt] list packages (v: verbose; t: time of build; n: native; m: foreign)"
    echo "  -c      clean global pacman;"
    echo "  -p      save local packages;"
    echo "  -u      update local pacman;"
    exit 2
}

function clean {
    if [[ ! -n $(pacman -Qdt) ]]; then
        echo "No orphans to remove."
    else
        sudo pacman -Rs $(pacman -Qdtq)
    fi
}

function update_repo {
    clean_repo main 1
    clean_repo abs 1

    # Sync pacman local db
    sudo pacman --config=$PACDIR/pacman.conf -Sy
}

function clean_repo {
    cd $PACDIR/$1
    dbfile="local-$1.db"
    sudo rm -f $dbfile*
    sudo paccache -rvc . -k1
    if [ $2 ]; then
        sudo repo-add "local-$1.db.tar.gz" *.pkg.tar.xz
    fi
}

function save_packages {
    pkglist -ln > $PACDIR/main.txt
    pkglist -lm > $PACDIR/abs.txt
    pacman -Q > $PACDIR/all.txt

    clean_repo abs

    sudo rsync -av /var/cache/pacman/pkg/ $PACDIR/main/
    clean_repo main
}
function list_packages {
    list=$(comm -23 <(pacman -Qeq$filter) <(pacman -Qgq base base-devel | sort))
    expac -Q -t '%Y-%m-%d %H:%M' "$format" $(echo $list)
}

reset="\e[0m"
colorM="\e[1;35m"
format="%n"

while getopts "cpulvtmnh" opt; do
    case $opt in
        p) operation=save_packages;;
        c) operation=clean;;
        u) operation=update_repo;;
        v) format="$colorM%n$reset: %d";;
        n) filter="n";;
        m) filter="m";;
        t) format="%l $format";;
        l) operation=list_packages;;
        h) operation=usage;;
    esac
done

if [ $operation ]; then
    $operation
else
    usage
fi
