#!/bin/bash
# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -exuo pipefail

path=${path:-$(pwd)}
name=${name:-$(basename -- "$path")}

#tpl=${tpl:-arch}
#base_url=https://uk.images.linuxcontainers.org/images/archlinux/current/amd64/default
tpl=xenial
base_url=https://uk.images.linuxcontainers.org/images/ubuntu/xenial/amd64/default
(machinectl list-images | grep -E "$tpl\s") || (
time_dir=$(curl -s $base_url | grep -o '/20[^/]*/' | tail -n1)
file_url=${base_url}${time_dir}rootfs.tar.xz
curl -o /tmp/$tpl.tar.xz $file_url
cd /var/lib/machines
sudo mkdir $tpl
sudo tar xf /tmp/$tpl.tar.xz -C $tpl
)

!(machinectl list-images | grep -E "$name\s") || (
machinectl kill $name || true
sleep 2
machinectl remove $name
)

machinectl clone $tpl $name

sudo mkdir -p /etc/systemd/nspawn/
cat <<EOF | sudo tee /etc/systemd/nspawn/$name.nspawn
[Exec]
PrivateUsers=false
#PrivateUsersChown=true
[Network]
VirtualEthernet=false
[Files]
Bind=$path:/opt/$name
EOF

machinectl start $name
sleep 1

machinectl shell $name /bin/sh -c "echo $name > /etc/hostname"

machinectl stop $name
sleep 1
machinectl start $name

#machinectl enable $name
#systemctl enable machines.target
